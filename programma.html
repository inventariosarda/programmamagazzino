<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PROGRAMMA — Programma Magazzino</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div id="debugPanel" style="position:fixed;left:10px;bottom:10px;right:10px;max-height:35vh;overflow:auto;z-index:9999;display:none;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px;font-size:12px;line-height:1.4;color:#e5e7eb">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px">
      <b>Debug</b>
      <button id="debugClose" style="border:none;background:rgba(255,255,255,.1);color:#e5e7eb;padding:6px 10px;border-radius:10px;cursor:pointer">Chiudi</button>
    </div>
    <div id="debugLog"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <a href="./index.html" style="text-decoration:none">
          <div style="font-size:18px;font-weight:800">Programma Magazzino</div>
        </a>
        <span class="badge">PROGRAMMA</span>
      </div>

      <div class="row" style="flex-wrap:wrap;justify-content:flex-end">
        <button class="btn secondary" id="prevDay" type="button">⬅</button>
        <div class="badge" id="dayLabel">—</div>
        <button class="btn secondary" id="nextDay" type="button">➡</button>

        <div class="field" style="min-width:160px">
          <label style="display:none">Data</label>
          <input type="date" id="datePick"/>
        </div>

        <a class="btn secondary" href="./setup_dipendenti.html">Setup Dipendenti</a>
        <a class="btn secondary" href="./setup_reparti.html">Setup Reparti</a>
        <button class="btn secondary" id="btnCopyPrev" type="button">Duplica giorno precedente</button>
        <button class="btn" id="btnPrint" type="button">Stampa PDF</button>
        <button class="btn secondary" id="btnExcel" type="button">Excel</button>
        <button class="btn danger" id="btnLogout">Esci</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header><h2>Reparti (trascina i dipendenti nei turni • + turno dal reparto)</h2><span class="badge" id="saveState">—</span></header>
        <div class="content" id="deptBoard" style="display:flex;flex-direction:column;gap:10px"></div>
      </div>

      <div class="card sticky">
        <header><h2>Dipendenti</h2><span class="badge" id="poolCount">—</span></header>
        <div class="content">
          <div class="field" style="min-width:240px">
            <label>Cerca</label>
            <input id="search" placeholder="scrivi per filtrare..."/>
          </div>
          <hr class="sep"/>
          <div id="pool" style="display:flex;flex-direction:column;gap:8px"></div>
          <hr class="sep"/>
          <div class="small muted">
            Suggerimento: trascina un nome in un turno. Per rimuoverlo, usa la ✕ sul “chip”.
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-app-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-firestore-compat.js"></script>
  <script src="./js/firebase-config-global.js"></script>

<script type="module">
  window.__MODULE_LOADED__ = (window.__MODULE_LOADED__||[]);
window.__MODULE_LOADED__.push({page:'programma.html', ts:Date.now()});
console.log('[MODULE]', 'programma.html', 'loaded');

import { auth, db, fb } from "./js/firebase.js";
  import { $, $$, escapeHtml, formatISODate, parseISODate, startOfWeek, weekIdFromDate, humanDate, debounce } from "./js/utils.js";

  const deptBoard = $("#deptBoard");
  const pool = $("#pool");
  const dayLabel = $("#dayLabel");
  const datePick = $("#datePick");
  const saveState = $("#saveState");
  const poolCount = $("#poolCount");

  let departments = []; // {id,name,order,shifts}
  let employees = [];   // {id,name,active}
  let dayISO = formatISODate(new Date());
  let dayData = null;   // { assignments: { deptId: {s1:[], s2:[]} } }
  let draggingEmpId = null;

  function setSaving(t){ saveState.textContent = t; }

  fb.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href = "./index.html"; return; }
    initDate(dayISO);
    await loadSetup();
    await loadDay();
    renderAll();
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await fb.signOut(auth);
    location.href = "./index.html";
  });

  function initDate(iso){
    dayISO = iso;
    datePick.value = dayISO;
    dayLabel.textContent = humanDate(parseISODate(dayISO));
  }

  $("#prevDay").addEventListener("click", async ()=>{
    const d = parseISODate(dayISO);
    d.setDate(d.getDate()-1);
    initDate(formatISODate(d));
    await loadDay();
    renderAll();
  });

  $("#nextDay").addEventListener("click", async ()=>{
    const d = parseISODate(dayISO);
    d.setDate(d.getDate()+1);
    initDate(formatISODate(d));
    await loadDay();
    renderAll();
  });

  $("#btnCopyPrev").addEventListener("click", async ()=>{
    if(!confirm("Vuoi duplicare il programma del giorno precedente su questo giorno? (Sovrascrive le assegnazioni di oggi)")) return;
    try{
      setSaving("Duplico…");
      const cur = new Date(currentDate + "T00:00:00");
      const prev = new Date(cur.getTime() - 24*60*60*1000);
      const prevISO = prev.toISOString().slice(0,10);

      const prevDoc = await fb.getDoc(fb.doc(db, "program_days", prevISO));
      const prevData = prevDoc.exists() ? (prevDoc.data() || {}) : null;

      if(!prevData || !prevData.assignments){
        alert("Nessun programma trovato per il giorno precedente (" + prevISO + ").");
        await loadAbsences();
    setSaving("Pronto");
        return;
      }

      dayData.assignments = JSON.parse(JSON.stringify(prevData.assignments));
      await fb.setDoc(fb.doc(db, "program_days", currentDate), dayData, { merge: true });
      renderAll();
      setSaving("Duplicato");
      setTimeout(()=>setSaving("Pronto"), 1200);
    }catch(e){
      console.error(e);
      alert("Errore duplicazione: " + (e?.message || e));
      setSaving("Errore");
    }
  });

  datePick.addEventListener("change", async ()=>{
    if(!datePick.value) return;
    initDate(datePick.value);
    await loadDay();
    renderAll();
  });

  $("#search").addEventListener("input", ()=>{
    renderPool();
  });

  $("#btnPrint").addEventListener("click", ()=>{
    // apre pagina print della settimana del giorno selezionato
    const d = parseISODate(dayISO);
    const weekId = weekIdFromDate(d);
    const url = `./print.html?week=${encodeURIComponent(weekId)}`;
    window.open(url, "_blank");
  });

  $("#btnExcel").addEventListener("click", async ()=>{
    await exportExcel();
  });

  async function loadSetup(){
    // departments
    const qd = fb.query(fb.collection(db, "settings_departments"), fb.orderBy("order"));
    const sd = await fb.getDocs(qd);
    departments = [];
    sd.forEach(docu=>{
      const d = docu.data();
      departments.push({ id: docu.id, ...d });
    });

    // employees
    const qe = fb.query(fb.collection(db, "settings_employees"), fb.orderBy("name"));
    const se = await fb.getDocs(qe);
    employees = [];
    se.forEach(docu=>{
      const e = docu.data();
      if(e.active === false) return;
      employees.push({ id: docu.id, ...e });
    });
  }

  function dayDocRef(){
    const d = parseISODate(dayISO);
    const weekId = weekIdFromDate(d);
    return fb.doc(db, "schedules", weekId, "days", dayISO);
  }

  
  let absencesToday = { ferie: new Set(), permesso: new Set(), malattia: new Set() };

  async function loadAbsences(){
    absencesToday = { ferie: new Set(), permesso: new Set(), malattia: new Set() };
    try{
      const snap = await fb.getDocs(fb.collection(db, "settings_absences"));
      snap.forEach(docu=>{
        const a = docu.data() || {};
        const from = a.from;
        const to = a.to || a.from;
        if(!a.empId || !a.type || !from) return;
        if(currentDate >= from && currentDate <= to){
          if(a.type === "ferie") absencesToday.ferie.add(a.empId);
          if(a.type === "permesso") absencesToday.permesso.add(a.empId);
          if(a.type === "malattia") absencesToday.malattia.add(a.empId);
        }
      });
    }catch(e){
      console.warn("Absences load failed", e);
    }
  }

async function loadDay(){
    setSaving("Carico…");
    const ref = dayDocRef();
    const snap = await fb.getDoc(ref);
    if(snap.exists()){
      dayData = snap.data();
    } else {
      dayData = { assignments: {} };
      // inizializza reparti con array vuoti
      for(const dep of departments){
        dayData.assignments[dep.id] = { s1: [], s2: [] };
      }
      await fb.setDoc(ref, dayData);
    }

    // garantisci che tutti i reparti/sottoreparti/turni esistano
    dayData.assignments = dayData.assignments || {};

    for(const dep of departments){
      const shiftsObj = dep.shifts || {};
      const shiftKeys = Object.keys(shiftsObj);
      const subdeps = (Array.isArray(dep.subdeps) && dep.subdeps.length) ? dep.subdeps : [{ id: '_main', name: dep.name || dep.id, order: 0 }];
      for(const sd of subdeps){
        for(const sk of shiftKeys){
          ensureSlot(dep.id, sd.id, sk);
        }
      }
    }
    setSaving("Pronto");
  }

  
  // Debounce salvataggio orari/turni su Firestore (per evitare troppe scritture)
  const shiftSaveTimers = new Map();
  function debounceKey(depId, subId){ return depId + "||" + subId; }

  async function updateDepartment(depId, patch){
    await fb.updateDoc(fb.doc(db, "settings_departments", depId), patch);
  }

  function updateSubdepArray(dep, subId, updater){
    const arr = (Array.isArray(dep.subdeps) ? dep.subdeps.slice() : []);
    const idx = arr.findIndex(x=>x.id===subId);
    if(idx < 0) return arr;
    arr[idx] = updater({ ...arr[idx] });
    return arr;
  }

  function saveShiftDebounced(dep, subId, nextSubdepsOrShifts){
    const key = debounceKey(dep.id, subId);
    if(shiftSaveTimers.has(key)) clearTimeout(shiftSaveTimers.get(key));
    shiftSaveTimers.set(key, setTimeout(async ()=>{
      try{
        setSaving("Salvo orario…");
        if(subId === "_main"){
          await updateDepartment(dep.id, { shifts: nextSubdepsOrShifts });
        } else {
          await updateDepartment(dep.id, { subdeps: nextSubdepsOrShifts });
        }
        await loadSetup();
        await loadDay();
        renderAll();
        setSaving("Orario salvato");
      }catch(e){
        console.error(e);
        setSaving("Errore");
        alert("Errore salvataggio: " + (e?.message || e));
      }
    }, 450));
  }

const saveDayDebounced = debounce(async ()=>{
    try{
      setSaving("Salvo…");
      await fb.setDoc(dayDocRef(), dayData, { merge: true });
      setSaving("Salvato");
    }catch(e){
      setSaving("Errore salvataggio");
      console.error(e);
    }
  }, 450);
  function assignKey(depId, subId, shiftKey){ return `${depId}::${subId}::${shiftKey}`; }

  function ensureSlot(depId, subId, shiftKey){
    dayData.assignments = dayData.assignments || {};
    const k = assignKey(depId, subId, shiftKey);
    if(!dayData.assignments[k]) dayData.assignments[k] = { staff: [], leader: null };
    dayData.assignments[k].staff = dayData.assignments[k].staff || [];
    if(typeof dayData.assignments[k].leader === 'undefined') dayData.assignments[k].leader = null;
    return dayData.assignments[k];
  }

  function removeFromAllAssignments(empId){
    dayData.assignments = dayData.assignments || {};
    for(const k of Object.keys(dayData.assignments)){
      const slot = dayData.assignments[k];
      if(!slot) continue;
      if(Array.isArray(slot.staff)){
        const idx = slot.staff.indexOf(empId);
        if(idx>=0) slot.staff.splice(idx,1);
      }
      if(slot.leader === empId) slot.leader = null;
    }
  }

  function addStaff(depId, subId, shiftKey, empId){
    removeFromAllAssignments(empId);
    const slot = ensureSlot(depId, subId, shiftKey);
    if(!slot.staff.includes(empId)) slot.staff.push(empId);
  }

  function setLeader(depId, subId, shiftKey, empId){
    removeFromAllAssignments(empId);
    const slot = ensureSlot(depId, subId, shiftKey);
    slot.leader = empId;
  }

  function computeAssignedSet(){
    const set = new Set();
    dayData.assignments = dayData.assignments || {};
    for(const k of Object.keys(dayData.assignments)){
      const slot = dayData.assignments[k];
      if(!slot) continue;
      (slot.staff||[]).forEach(id=>set.add(id));
      if(slot.leader) set.add(slot.leader);
    }
    absencesToday.ferie.forEach(id=>set.add(id));
    absencesToday.permesso.forEach(id=>set.add(id));
    absencesToday.malattia.forEach(id=>set.add(id));
    return set;
  }

  function renderAll(){
    renderDepartmentsBoard();
    renderPool();
  }
  


function renderDepartmentsBoard(){
  deptBoard.innerHTML = "";

  // --- sezioni assenze (no orario)
  const absenceWrap = document.createElement("div");
  absenceWrap.className = "dept";
  absenceWrap.innerHTML = `
    <div class="dept-head">
      <div>
        <div class="dept-name">Assenze (auto)</div>
        <div class="dept-sub">Ferie / Permessi / Malattia</div>
      </div>
      <div class="badge">${escapeHtml(currentDate)}</div>
    </div>
  `;
  const absContent = document.createElement("div");
  absContent.className = "content";
  absContent.style.padding = "12px";
  absContent.style.display = "flex";
  absContent.style.flexDirection = "column";
  absContent.style.gap = "12px";

  function renderAbsBlock(title, setIds){
    const box = document.createElement("div");
    box.className = "shift";
    box.style.gridTemplateColumns = "1fr";
    const names = employees.filter(e=>setIds.has(e.id)).map(e=>e.name);
    box.innerHTML = `
      <div class="shift-title"><b>${escapeHtml(title)}</b></div>
      <div class="dropzone" style="min-height:44px">${names.length ? names.map(n=>`<div class="chip"><span>${escapeHtml(n)}</span></div>`).join("") : '<div class="small muted">Nessuno</div>'}</div>
    `;
    return box;
  }

  absContent.appendChild(renderAbsBlock("Ferie", absencesToday.ferie));
  absContent.appendChild(renderAbsBlock("Permessi", absencesToday.permesso));
  absContent.appendChild(renderAbsBlock("Malattia", absencesToday.malattia));
  absenceWrap.appendChild(absContent);
  deptBoard.appendChild(absenceWrap);

  for(const dep of departments){
    const depShifts = dep.shifts || {};
    const depShiftKeys = Object.keys(depShifts).sort((a,b)=>{
      const na = Number(a.replace(/\D/g,"")) || 0;
      const nb = Number(b.replace(/\D/g,"")) || 0;
      return na - nb;
    });

    const hasSubdeps = Array.isArray(dep.subdeps) && dep.subdeps.length > 0;

    const wrap = document.createElement("div");
    wrap.className = "dept";
    wrap.innerHTML = `
      <div class="dept-head">
        <div>
          <div class="dept-name">${escapeHtml(dep.name || dep.id)}</div>
          <div class="dept-sub">${hasSubdeps ? "Con sottoreparti" : "Reparto"}${dep.isExtra ? " • Attività aggiuntiva" : ""}</div>
        </div>
        <div class="row" style="gap:8px">
          <button class="btn secondary smallbtn" data-act="addShiftMain" type="button">+ Turno</button>
          <div class="badge">${escapeHtml(dep.id)}</div>
        </div>
      </div>
    `;

    const content = document.createElement("div");
    content.className = "content";
    content.style.padding = "12px";
    content.style.display = "flex";
    content.style.flexDirection = "column";
    content.style.gap = "12px";

    // Notes reparto (sempre)
    const notesBox = document.createElement("div");
    notesBox.innerHTML = `
      <div class="field" style="margin:0">
        <label>NOTE (opzionali)</label>
        <textarea data-act="notesDept" rows="2" placeholder="Note...">${escapeHtml(dep.notes || "")}</textarea>
      </div>
    `;
    const deptNotesArea = notesBox.querySelector('textarea[data-act="notesDept"]');
    deptNotesArea.addEventListener("input", ()=>{
      const key = "notes||" + dep.id + "||_main";
      if(shiftSaveTimers.has(key)) clearTimeout(shiftSaveTimers.get(key));
      shiftSaveTimers.set(key, setTimeout(async ()=>{
        try{
          setSaving("Salvo note…");
          await updateDepartment(dep.id, { notes: deptNotesArea.value });
          await loadSetup(); await loadDay(); renderAll();
          setSaving("Pronto");
        }catch(e){ console.error(e); setSaving("Errore"); }
      }, 450));
    });
    content.appendChild(notesBox);

    // Render shifts: if no subdeps, use dept shift directly (no created _main box)
    if(!hasSubdeps){
      const sdId = "_main";
      for(const shiftKey of depShiftKeys){
        const sft = depShifts[shiftKey] || {};
        const label = sft.label || "Turno";
        const startT = sft.start || "08:00";
        const endT = sft.end || "17:00";
        ensureSlot(dep.id, sdId, shiftKey);
        const slot = dayData.assignments[assignKey(dep.id, sdId, shiftKey)];

        const block = document.createElement("div");
        block.className = "shift";
        block.style.gridTemplateColumns = "1fr";
        block.innerHTML = dep.isExtra ? `
          <div class="shift-title"><b>${escapeHtml(label)}</b></div>
          <div style="margin-top:10px">
            <div class="small muted" style="margin-bottom:6px">Dipendente (attività aggiuntiva)</div>
            <select data-act="extraSelect" class="select" style="width:100%"></select>
          </div>
        ` : `
          <div class="shift-title" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
            <div style="min-width:180px;flex:1;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
              <b>${escapeHtml(label)}</b>
              <span class="pill">${escapeHtml(startT)}–${escapeHtml(endT)}</span>
            </div>
            <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
              <input type="time" data-act="timeStart" value="${escapeHtml(startT)}" style="max-width:120px"/>
              <span class="small muted">→</span>
              <input type="time" data-act="timeEnd" value="${escapeHtml(endT)}" style="max-width:120px"/>
              <button class="btn danger smallbtn" data-act="delShift" type="button">Togli</button>
            </div>
          </div>

          <div style="margin-top:10px">
            <div class="small muted" style="margin-bottom:6px">Capoturno</div>
            <div class="dropzone" data-role="leader" data-dep="${dep.id}" data-sub="${sdId}" data-shift="${escapeHtml(shiftKey)}" style="min-height:44px"></div>
          </div>

          <div style="margin-top:10px">
            <div class="small muted" style="margin-bottom:6px">Operatori</div>
            <div class="dropzone" data-role="staff" data-dep="${dep.id}" data-sub="${sdId}" data-shift="${escapeHtml(shiftKey)}"></div>
          </div>
        `;

        // Extra select logic
        if(dep.isExtra){
          const sel = block.querySelector('select[data-act="extraSelect"]');
          sel.innerHTML = `<option value="">—</option>` + employees
            .filter(e=>e.active !== false)
            .map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`)
            .join("");
          const current = (slot.staff && slot.staff[0]) ? slot.staff[0] : "";
          sel.value = current;
          sel.addEventListener("change", ()=>{
            const val = sel.value || "";
            slot.staff = val ? [val] : [];
            saveDayDebounced();
            renderAll();
          });
        } else {
          // time edit
          const inpStart = block.querySelector('[data-act="timeStart"]');
          const inpEnd = block.querySelector('[data-act="timeEnd"]');
          function onTimeChange(){
            const newStart = inpStart.value || startT;
            const newEnd = inpEnd.value || endT;
            const next = JSON.parse(JSON.stringify(depShifts));
            next[shiftKey] = { ...(next[shiftKey]||{}), start: newStart, end: newEnd };
            saveShiftDebounced(dep, "_main", next);
          }
          inpStart.addEventListener("input", onTimeChange);
          inpEnd.addEventListener("input", onTimeChange);

          // del shift
          block.querySelector('[data-act="delShift"]').addEventListener("click", async ()=>{
            if(!confirm("Togliere questo turno?")) return;
            try{
              setSaving("Tolgo turno…");
              const next = JSON.parse(JSON.stringify(depShifts));
              delete next[shiftKey];
              if(Object.keys(next).length===0){ alert("Deve rimanere almeno 1 turno."); setSaving("Pronto"); return; }
              await updateDepartment(dep.id, { shifts: next });
              await loadSetup(); await loadDay(); renderAll();
              setSaving("Pronto");
            }catch(e){ console.error(e); setSaving("Errore"); }
          });

          // render leader/staff + drag targets (reuse helpers)
          // leader
          const leaderZone = block.querySelector('.dropzone[data-role="leader"]');
          const leaderId = slot.leader;
          if(!leaderId) leaderZone.innerHTML = `<div class="small muted">Trascina qui il capoturno</div>`;
          else {
            const emp = employees.find(e=>e.id===leaderId);
            leaderZone.innerHTML = "";
            if(emp){
              const chip = document.createElement("div");
              chip.className = "chip"; chip.draggable = true;
              chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
              chip.addEventListener("dragstart", (ev)=>{ draggingEmpId = emp.id; ev.dataTransfer.setData("text/plain", emp.id); });
              chip.querySelector("button").addEventListener("click", ()=>{ slot.leader=null; saveDayDebounced(); renderAll(); });
              leaderZone.appendChild(chip);
            }
          }
          // staff
          const staffZone = block.querySelector('.dropzone[data-role="staff"]');
          const ids = slot.staff||[];
          if(ids.length===0) staffZone.innerHTML = `<div class="small muted">Trascina qui i dipendenti</div>`;
          else {
            staffZone.innerHTML = "";
            ids.forEach(empId=>{
              const emp = employees.find(e=>e.id===empId);
              if(!emp) return;
              const chip = document.createElement("div");
              chip.className = "chip"; chip.draggable = true;
              chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
              chip.addEventListener("dragstart", (ev)=>{ draggingEmpId = emp.id; ev.dataTransfer.setData("text/plain", emp.id); });
              chip.querySelector("button").addEventListener("click", ()=>{ removeFromAllAssignments(empId); saveDayDebounced(); renderAll(); });
              staffZone.appendChild(chip);
            });
          }
          block.querySelectorAll(".dropzone").forEach(zone=>{
            zone.addEventListener("dragover", (ev)=>{ ev.preventDefault(); zone.classList.add("over"); });
            zone.addEventListener("dragleave", ()=>zone.classList.remove("over"));
            zone.addEventListener("drop", (ev)=>{
              ev.preventDefault(); zone.classList.remove("over");
              const empId = ev.dataTransfer.getData("text/plain")||draggingEmpId;
              if(!empId) return;
              const role = zone.getAttribute("data-role");
              if(role==="leader") setLeader(dep.id, sdId, shiftKey, empId);
              else addStaff(dep.id, sdId, shiftKey, empId);
              saveDayDebounced(); renderAll();
            });
          });
        }

        content.appendChild(block);
      }
    } else {
      // With subdeps: keep existing style but without auto-creating empty ones (use what exists only)
      const subdeps = dep.subdeps.slice().sort((a,b)=>(a.order||0)-(b.order||0));
      for(const sd of subdeps){
        const sdShifts = (sd.shifts && Object.keys(sd.shifts).length) ? sd.shifts : depShifts;
        const shiftKeys = Object.keys(sdShifts).sort((a,b)=>{
          const na = Number(a.replace(/\D/g,"")) || 0;
          const nb = Number(b.replace(/\D/g,"")) || 0;
          return na - nb;
        });
        const isExtra = !!sd.isExtra;
        const sdBox = document.createElement("div");
        sdBox.className = "dept";
        sdBox.style.background = "rgba(255,255,255,.02)";
        sdBox.innerHTML = `
          <div class="dept-head" style="border-bottom: 1px solid rgba(255,255,255,.06)">
            <div>
              <div class="dept-name" style="font-size:14px">${escapeHtml(sd.name)}</div>
              <div class="dept-sub">Sottoreparto${isExtra ? " • Attività aggiuntiva" : ""}</div>
            </div>
            <div class="row" style="gap:8px;flex-wrap:wrap">
              <button class="btn secondary smallbtn" data-act="addShiftSub" type="button">+ Turno</button>
            </div>
          </div>
          <div class="content" style="padding:12px;display:flex;flex-direction:column;gap:10px">
            <div class="field" style="margin:0">
              <label>NOTE (opzionali)</label>
              <textarea data-act="notesSub" rows="2" placeholder="Note...">${escapeHtml(sd.notes || "")}</textarea>
            </div>
          </div>
        `;
        const sdContent = sdBox.querySelector(".content");

        // note sub
        const subNotesArea = sdBox.querySelector('textarea[data-act="notesSub"]');
        subNotesArea.addEventListener("input", ()=>{
          const key = "notes||" + dep.id + "||" + sd.id;
          if(shiftSaveTimers.has(key)) clearTimeout(shiftSaveTimers.get(key));
          shiftSaveTimers.set(key, setTimeout(async ()=>{
            try{
              setSaving("Salvo note…");
              const nextSubdeps = updateSubdepArray(dep, sd.id, (x)=>{ x.notes=subNotesArea.value; return x; });
              await updateDepartment(dep.id, { subdeps: nextSubdeps });
              await loadSetup(); await loadDay(); renderAll();
              setSaving("Pronto");
            }catch(e){ console.error(e); setSaving("Errore"); }
          }, 450));
        });

        for(const shiftKey of shiftKeys){
          const sft = sdShifts[shiftKey] || {};
          const label = sft.label || "Turno";
          const startT = sft.start || "08:00";
          const endT = sft.end || "17:00";
          ensureSlot(dep.id, sd.id, shiftKey);
          const slot = dayData.assignments[assignKey(dep.id, sd.id, shiftKey)];

          const block = document.createElement("div");
          block.className = "shift";
          block.style.gridTemplateColumns = "1fr";
          block.innerHTML = isExtra ? `
            <div class="shift-title"><b>${escapeHtml(label)}</b></div>
            <div style="margin-top:10px">
              <div class="small muted" style="margin-bottom:6px">Dipendente (attività aggiuntiva)</div>
              <select data-act="extraSelect" class="select" style="width:100%"></select>
            </div>
          ` : `
            <div class="shift-title" style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
              <div style="min-width:180px;flex:1;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
                <b>${escapeHtml(label)}</b>
                <span class="pill">${escapeHtml(startT)}–${escapeHtml(endT)}</span>
              </div>
              <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
                <input type="time" data-act="timeStart" value="${escapeHtml(startT)}" style="max-width:120px"/>
                <span class="small muted">→</span>
                <input type="time" data-act="timeEnd" value="${escapeHtml(endT)}" style="max-width:120px"/>
                <button class="btn danger smallbtn" data-act="delShift" type="button">Togli</button>
              </div>
            </div>
            <div style="margin-top:10px">
              <div class="small muted" style="margin-bottom:6px">Capoturno</div>
              <div class="dropzone" data-role="leader" data-dep="${dep.id}" data-sub="${escapeHtml(sd.id)}" data-shift="${escapeHtml(shiftKey)}" style="min-height:44px"></div>
            </div>
            <div style="margin-top:10px">
              <div class="small muted" style="margin-bottom:6px">Operatori</div>
              <div class="dropzone" data-role="staff" data-dep="${dep.id}" data-sub="${escapeHtml(sd.id)}" data-shift="${escapeHtml(shiftKey)}"></div>
            </div>
          `;
          if(isExtra){
            const sel = block.querySelector('select[data-act="extraSelect"]');
            sel.innerHTML = `<option value="">—</option>` + employees
              .filter(e=>e.active !== false)
              .map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`)
              .join("");
            const current = (slot.staff && slot.staff[0]) ? slot.staff[0] : "";
            sel.value = current;
            sel.addEventListener("change", ()=>{
              const val = sel.value || "";
              slot.staff = val ? [val] : [];
              saveDayDebounced(); renderAll();
            });
          } else {
            // drag/drop+time would mirror main; omitted here for brevity, relies on existing code paths? (but must work)
            // For safety, keep simpler: treat like main non-extra (same as above) by reusing same inline logic from main
            const inpStart = block.querySelector('[data-act="timeStart"]');
            const inpEnd = block.querySelector('[data-act="timeEnd"]');
            function onTimeChange(){
              const newStart = inpStart.value || startT;
              const newEnd = inpEnd.value || endT;
              const nextSubdeps = updateSubdepArray(dep, sd.id, (x)=>{
                const base = (x.shifts && Object.keys(x.shifts).length) ? x.shifts : {};
                const next = JSON.parse(JSON.stringify(base));
                next[shiftKey] = { ...(next[shiftKey]||{}), start: newStart, end: newEnd, label };
                x.shifts = next;
                return x;
              });
              saveShiftDebounced(dep, sd.id, nextSubdeps);
            }
            inpStart.addEventListener("input", onTimeChange);
            inpEnd.addEventListener("input", onTimeChange);
            block.querySelector('[data-act="delShift"]').addEventListener("click", async ()=>{
              if(!confirm("Togliere questo turno?")) return;
              try{
                setSaving("Tolgo turno…");
                const nextSubdeps = updateSubdepArray(dep, sd.id, (x)=>{
                  const base = (x.shifts && Object.keys(x.shifts).length) ? x.shifts : {};
                  const next = JSON.parse(JSON.stringify(base));
                  delete next[shiftKey];
                  x.shifts = next;
                  return x;
                });
                const after = nextSubdeps.find(x=>x.id===sd.id);
                const afterShifts = after?.shifts || {};
                if(Object.keys(afterShifts).length===0){ alert("Deve rimanere almeno 1 turno."); setSaving("Pronto"); return; }
                await updateDepartment(dep.id, { subdeps: nextSubdeps });
                await loadSetup(); await loadDay(); renderAll();
                setSaving("Pronto");
              }catch(e){ console.error(e); setSaving("Errore"); }
            });

            const leaderZone = block.querySelector('.dropzone[data-role="leader"]');
            const leaderId = slot.leader;
            if(!leaderId) leaderZone.innerHTML = `<div class="small muted">Trascina qui il capoturno</div>`;
            else {
              const emp = employees.find(e=>e.id===leaderId);
              leaderZone.innerHTML = "";
              if(emp){
                const chip = document.createElement("div");
                chip.className = "chip"; chip.draggable = true;
                chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
                chip.addEventListener("dragstart", (ev)=>{ draggingEmpId = emp.id; ev.dataTransfer.setData("text/plain", emp.id); });
                chip.querySelector("button").addEventListener("click", ()=>{ slot.leader=null; saveDayDebounced(); renderAll(); });
                leaderZone.appendChild(chip);
              }
            }
            const staffZone = block.querySelector('.dropzone[data-role="staff"]');
            const ids = slot.staff||[];
            if(ids.length==0) staffZone.innerHTML = `<div class="small muted">Trascina qui i dipendenti</div>`;
            else {
              staffZone.innerHTML = "";
              ids.forEach(empId=>{
                const emp = employees.find(e=>e.id===empId);
                if(!emp) return;
                const chip = document.createElement("div");
                chip.className = "chip"; chip.draggable = true;
                chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
                chip.addEventListener("dragstart", (ev)=>{ draggingEmpId = emp.id; ev.dataTransfer.setData("text/plain", emp.id); });
                chip.querySelector("button").addEventListener("click", ()=>{ removeFromAllAssignments(empId); saveDayDebounced(); renderAll(); });
                staffZone.appendChild(chip);
              });
            }
            block.querySelectorAll(".dropzone").forEach(zone=>{
              zone.addEventListener("dragover", (ev)=>{ ev.preventDefault(); zone.classList.add("over"); });
              zone.addEventListener("dragleave", ()=>zone.classList.remove("over"));
              zone.addEventListener("drop", (ev)=>{
                ev.preventDefault(); zone.classList.remove("over");
                const empId = ev.dataTransfer.getData("text/plain")||draggingEmpId;
                if(!empId) return;
                const role = zone.getAttribute("data-role");
                if(role==="leader") setLeader(dep.id, sd.id, shiftKey, empId);
                else addStaff(dep.id, sd.id, shiftKey, empId);
                saveDayDebounced(); renderAll();
              });
            });
          }
          sdContent.appendChild(block);
        }

        // Add shift button for this subdep
        sdBox.querySelector('[data-act="addShiftSub"]').addEventListener("click", async ()=>{
          const start="08:00", end="17:00", label="Turno";
          try{
            setSaving("Aggiungo turno…");
            const nums = shiftKeys.map(k=>Number(k.replace(/\D/g,""))||0);
            const nextN = (Math.max(...nums, 0) + 1);
            const newKey = "s" + nextN;
            const nextSubdeps = updateSubdepArray(dep, sd.id, (x)=>{
              const base = (x.shifts && Object.keys(x.shifts).length) ? x.shifts : {};
              const next = JSON.parse(JSON.stringify(base));
              next[newKey] = { label, start, end };
              x.shifts = next;
              return x;
            });
            await updateDepartment(dep.id, { subdeps: nextSubdeps });
            await loadSetup(); await loadDay(); renderAll();
            setSaving("Pronto");
          }catch(e){ console.error(e); setSaving("Errore"); }
        });

        content.appendChild(sdBox);
      }
    }

    wrap.appendChild(content);
    deptBoard.appendChild(wrap);

    // Add shift main
    wrap.querySelector('[data-act="addShiftMain"]').addEventListener("click", async ()=>{
      const start="08:00", end="17:00", label="Turno";
      try{
        setSaving("Aggiungo turno…");
        const nums = depShiftKeys.map(k=>Number(k.replace(/\D/g,""))||0);
        const nextN = (Math.max(...nums, 0) + 1);
        const newKey = "s" + nextN;
        const next = JSON.parse(JSON.stringify(depShifts));
        next[newKey] = { label, start, end };
        await updateDepartment(dep.id, { shifts: next });
        await loadSetup(); await loadDay(); renderAll();
        setSaving("Pronto");
      }catch(e){ console.error(e); setSaving("Errore"); }
    });
  }
}
function renderPool(){
    const q = ($("#search").value || "").trim().toLowerCase();
    const assigned = computeAssignedSet();
    const poolList = employees
      .filter(e => !assigned.has(e.id))
      .filter(e => !q || e.name.toLowerCase().includes(q));

    poolCount.textContent = `${poolList.length} liberi`;

    pool.innerHTML = "";
    if(poolList.length === 0){
      pool.innerHTML = `<div class="small muted">Nessun dipendente libero (o filtro attivo).</div>`;
      return;
    }
    for(const e of poolList){
      const row = document.createElement("div");
      row.className = "employee";
      row.draggable = true;
      row.innerHTML = `
        <div class="name">${escapeHtml(e.name)}</div>
        <div class="pill">drag</div>
      `;
      row.addEventListener("dragstart", (ev)=>{
        draggingEmpId = e.id;
        ev.dataTransfer.setData("text/plain", e.id);
        ev.dataTransfer.effectAllowed = "move";
      });
      row.addEventListener("dragend", ()=>{
        draggingEmpId = null;
      });
      pool.appendChild(row);
    }
  }

  // --- EXCEL EXPORT (settimana corrente) ---
  async function exportExcel(){
    const d = parseISODate(dayISO);
    const weekStart = startOfWeek(d);
    const days = [];
    for(let i=0;i<7;i++){
      const dd = new Date(weekStart);
      dd.setDate(weekStart.getDate()+i);
      days.push(formatISODate(dd));
    }
    const weekId = weekIdFromDate(d);

    // carica tutti i days doc della settimana
    const weekData = {}; // dayISO -> assignments
    for(const di of days){
      const ref = fb.doc(db, "schedules", weekId, "days", di);
      const snap = await fb.getDoc(ref);
      weekData[di] = snap.exists() ? (snap.data().assignments || {}) : {};
    }

    // carica SheetJS on-demand
    const { utils, writeFile } = await import("https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs");

    const header = ["REPARTO / TURNO", ...days.map(s=>s)];
    const rows = [header];

    for(const dep of departments){
      const s1 = dep.shifts?.s1 || { label:"Turno 1", start:"07:00", end:"13:00" };
      const s2 = dep.shifts?.s2 || { label:"Turno 2", start:"13:00", end:"19:00" };

      // Riga compatta per reparto: in ogni cella metti T1/T2
      const r = [`${dep.name}`];
      for(const di of days){
        const a = weekData[di]?.[dep.id] || { s1:[], s2:[] };
        const names1 = (a.s1||[]).map(id => employees.find(e=>e.id===id)?.name).filter(Boolean);
        const names2 = (a.s2||[]).map(id => employees.find(e=>e.id===id)?.name).filter(Boolean);
        const cell = `T1 (${s1.start}-${s1.end}): ${names1.join(", ")}\nT2 (${s2.start}-${s2.end}): ${names2.join(", ")}`;
        r.push(cell);
      }
      rows.push(r);
    }

    const ws = utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:22}, ...days.map(()=>({wch:34}))];

    const wb = utils.book_new();
    utils.book_append_sheet(wb, ws, "Programma");
    writeFile(wb, `programma-magazzino_${weekId}.xlsx`);
  }
</script>

<script>
(function(){
  const panel = document.getElementById('debugPanel');
  const logEl = document.getElementById('debugLog');
  const closeBtn = document.getElementById('debugClose');
  function show(){ panel.style.display='block'; }
  function log(msg){
    show();
    const div=document.createElement('div');
    div.textContent = msg;
    logEl.appendChild(div);
  }
  closeBtn && closeBtn.addEventListener('click', ()=> panel.style.display='none');

  window.addEventListener('error', (e)=>{
    log('[JS error] ' + (e.message || e.error || 'errore') + ' @ ' + (e.filename||'') + ':' + (e.lineno||'') );
  });
  window.addEventListener('unhandledrejection', (e)=>{
    log('[Promise] ' + (e.reason && (e.reason.message||String(e.reason))) );
  });

  // ping that base script executed
  log('[OK] Debug attivo. UserAgent: ' + navigator.userAgent);
})();
</script>

<script id="moduleStatusBanner">
(function(){
  function show(){
    const div=document.createElement('div');
    div.style.position='fixed';
    div.style.top='10px';
    div.style.left='10px';
    div.style.zIndex='99999';
    div.style.padding='8px 10px';
    div.style.borderRadius='12px';
    div.style.background='rgba(0,0,0,.75)';
    div.style.border='1px solid rgba(255,255,255,.18)';
    div.style.color='#e5e7eb';
    div.style.fontSize='12px';
    div.textContent = window.__MODULE_LOADED__ ? ('Module OK: ' + window.__MODULE_LOADED__.map(x=>x.page).join(', ')) : 'ATTENZIONE: moduli NON caricati';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 8000);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', show);
  else show();
})();
</script>
</body>
</html>
