<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PROGRAMMA — Programma Magazzino</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div id="debugPanel" style="position:fixed;left:10px;bottom:10px;right:10px;max-height:35vh;overflow:auto;z-index:9999;display:none;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px;font-size:12px;line-height:1.4;color:#e5e7eb">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px">
      <b>Debug</b>
      <button id="debugClose" style="border:none;background:rgba(255,255,255,.1);color:#e5e7eb;padding:6px 10px;border-radius:10px;cursor:pointer">Chiudi</button>
    </div>
    <div id="debugLog"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <a href="./index.html" style="text-decoration:none">
          <div style="font-size:18px;font-weight:800">Programma Magazzino</div>
        </a>
        <span class="badge">PROGRAMMA</span>
      </div>

      <div class="row" style="flex-wrap:wrap;justify-content:flex-end">
        <button class="btn secondary" id="prevDay" type="button">⬅</button>
        <div class="badge" id="dayLabel">—</div>
        <button class="btn secondary" id="nextDay" type="button">➡</button>

        <div class="field" style="min-width:160px">
          <label style="display:none">Data</label>
          <input type="date" id="datePick"/>
        </div>

        <a class="btn secondary" href="./setup_dipendenti.html">Setup Dipendenti</a>
        <a class="btn secondary" href="./setup_reparti.html">Setup Reparti</a>
        <button class="btn" id="btnPrint" type="button">Stampa PDF</button>
        <button class="btn secondary" id="btnExcel" type="button">Excel</button>
        <button class="btn danger" id="btnLogout">Esci</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header><h2>Reparti (trascina i dipendenti nei turni • + turno dal reparto)</h2><span class="badge" id="saveState">—</span></header>
        <div class="content" id="deptBoard" style="display:flex;flex-direction:column;gap:10px"></div>
      </div>

      <div class="card sticky">
        <header><h2>Dipendenti</h2><span class="badge" id="poolCount">—</span></header>
        <div class="content">
          <div class="field" style="min-width:240px">
            <label>Cerca</label>
            <input id="search" placeholder="scrivi per filtrare..."/>
          </div>
          <hr class="sep"/>
          <div id="pool" style="display:flex;flex-direction:column;gap:8px"></div>
          <hr class="sep"/>
          <div class="small muted">
            Suggerimento: trascina un nome in un turno. Per rimuoverlo, usa la ✕ sul “chip”.
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-app-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-firestore-compat.js"></script>
  <script src="./js/firebase-config-global.js"></script>

<script type="module">
  window.__MODULE_LOADED__ = (window.__MODULE_LOADED__||[]);
window.__MODULE_LOADED__.push({page:'programma.html', ts:Date.now()});
console.log('[MODULE]', 'programma.html', 'loaded');

import { auth, db, fb } from "./js/firebase.js";
  import { $, $$, escapeHtml, formatISODate, parseISODate, startOfWeek, weekIdFromDate, humanDate, debounce } from "./js/utils.js";

  const deptBoard = $("#deptBoard");
  const pool = $("#pool");
  const dayLabel = $("#dayLabel");
  const datePick = $("#datePick");
  const saveState = $("#saveState");
  const poolCount = $("#poolCount");

  let departments = []; // {id,name,order,shifts}
  let employees = [];   // {id,name,active}
  let dayISO = formatISODate(new Date());
  let dayData = null;   // { assignments: { deptId: {s1:[], s2:[]} } }
  let draggingEmpId = null;

  function setSaving(t){ saveState.textContent = t; }

  fb.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href = "./index.html"; return; }
    initDate(dayISO);
    await loadSetup();
    await loadDay();
    renderAll();
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await fb.signOut(auth);
    location.href = "./index.html";
  });

  function initDate(iso){
    dayISO = iso;
    datePick.value = dayISO;
    dayLabel.textContent = humanDate(parseISODate(dayISO));
  }

  $("#prevDay").addEventListener("click", async ()=>{
    const d = parseISODate(dayISO);
    d.setDate(d.getDate()-1);
    initDate(formatISODate(d));
    await loadDay();
    renderAll();
  });

  $("#nextDay").addEventListener("click", async ()=>{
    const d = parseISODate(dayISO);
    d.setDate(d.getDate()+1);
    initDate(formatISODate(d));
    await loadDay();
    renderAll();
  });

  datePick.addEventListener("change", async ()=>{
    if(!datePick.value) return;
    initDate(datePick.value);
    await loadDay();
    renderAll();
  });

  $("#search").addEventListener("input", ()=>{
    renderPool();
  });

  $("#btnPrint").addEventListener("click", ()=>{
    // apre pagina print della settimana del giorno selezionato
    const d = parseISODate(dayISO);
    const weekId = weekIdFromDate(d);
    const url = `./print.html?week=${encodeURIComponent(weekId)}`;
    window.open(url, "_blank");
  });

  $("#btnExcel").addEventListener("click", async ()=>{
    await exportExcel();
  });

  async function loadSetup(){
    // departments
    const qd = fb.query(fb.collection(db, "settings_departments"), fb.orderBy("order"));
    const sd = await fb.getDocs(qd);
    departments = [];
    sd.forEach(docu=>{
      const d = docu.data();
      departments.push({ id: docu.id, ...d });
    });

    // employees
    const qe = fb.query(fb.collection(db, "settings_employees"), fb.orderBy("name"));
    const se = await fb.getDocs(qe);
    employees = [];
    se.forEach(docu=>{
      const e = docu.data();
      if(e.active === false) return;
      employees.push({ id: docu.id, ...e });
    });
  }

  function dayDocRef(){
    const d = parseISODate(dayISO);
    const weekId = weekIdFromDate(d);
    return fb.doc(db, "schedules", weekId, "days", dayISO);
  }

  async function loadDay(){
    setSaving("Carico…");
    const ref = dayDocRef();
    const snap = await fb.getDoc(ref);
    if(snap.exists()){
      dayData = snap.data();
    } else {
      dayData = { assignments: {} };
      // inizializza reparti con array vuoti
      for(const dep of departments){
        dayData.assignments[dep.id] = { s1: [], s2: [] };
      }
      await fb.setDoc(ref, dayData);
    }

    // garantisci che tutti i reparti/sottoreparti/turni esistano
    dayData.assignments = dayData.assignments || {};

    for(const dep of departments){
      const shiftsObj = dep.shifts || {};
      const shiftKeys = Object.keys(shiftsObj);
      const subdeps = (Array.isArray(dep.subdeps) && dep.subdeps.length) ? dep.subdeps : [{ id: '_main', name: dep.name || dep.id, order: 0 }];
      for(const sd of subdeps){
        for(const sk of shiftKeys){
          ensureSlot(dep.id, sd.id, sk);
        }
      }
    }
    setSaving("Pronto");
  }

  const saveDayDebounced = debounce(async ()=>{
    try{
      setSaving("Salvo…");
      await fb.setDoc(dayDocRef(), dayData, { merge: true });
      setSaving("Salvato");
    }catch(e){
      setSaving("Errore salvataggio");
      console.error(e);
    }
  }, 450);
  function assignKey(depId, subId, shiftKey){ return `${depId}::${subId}::${shiftKey}`; }

  function ensureSlot(depId, subId, shiftKey){
    dayData.assignments = dayData.assignments || {};
    const k = assignKey(depId, subId, shiftKey);
    if(!dayData.assignments[k]) dayData.assignments[k] = { staff: [], leader: null };
    dayData.assignments[k].staff = dayData.assignments[k].staff || [];
    if(typeof dayData.assignments[k].leader === 'undefined') dayData.assignments[k].leader = null;
    return dayData.assignments[k];
  }

  function removeFromAllAssignments(empId){
    dayData.assignments = dayData.assignments || {};
    for(const k of Object.keys(dayData.assignments)){
      const slot = dayData.assignments[k];
      if(!slot) continue;
      if(Array.isArray(slot.staff)){
        const idx = slot.staff.indexOf(empId);
        if(idx>=0) slot.staff.splice(idx,1);
      }
      if(slot.leader === empId) slot.leader = null;
    }
  }

  function addStaff(depId, subId, shiftKey, empId){
    removeFromAllAssignments(empId);
    const slot = ensureSlot(depId, subId, shiftKey);
    if(!slot.staff.includes(empId)) slot.staff.push(empId);
  }

  function setLeader(depId, subId, shiftKey, empId){
    removeFromAllAssignments(empId);
    const slot = ensureSlot(depId, subId, shiftKey);
    slot.leader = empId;
  }

  function computeAssignedSet(){
    const set = new Set();
    dayData.assignments = dayData.assignments || {};
    for(const k of Object.keys(dayData.assignments)){
      const slot = dayData.assignments[k];
      if(!slot) continue;
      (slot.staff||[]).forEach(id=>set.add(id));
      if(slot.leader) set.add(slot.leader);
    }
    return set;
  }

  function renderAll(){
    renderDepartmentsBoard();
    renderPool();
  }
  function renderDepartmentsBoard(){

    deptBoard.innerHTML = "";

    for(const dep of departments){
      const shiftsObj = dep.shifts || {};
      const shiftKeys = Object.keys(shiftsObj).sort((a,b)=>{
        const na = Number(a.replace(/\D/g,"")) || 0;
        const nb = Number(b.replace(/\D/g,"")) || 0;
        return na - nb;
      });

      const subdeps = (Array.isArray(dep.subdeps) && dep.subdeps.length)
        ? dep.subdeps.slice().sort((a,b)=>(a.order||0)-(b.order||0))
        : [{ id: "_main", name: (dep.name||dep.id), order: 0 }];

      const wrap = document.createElement("div");
      wrap.className = "dept";

      wrap.innerHTML = `
        <div class="dept-head">
          <div>
            <div class="dept-name">${escapeHtml(dep.name || dep.id)}</div>
            <div class="dept-sub">Sottoreparti: ${subdeps.length} • Turni: ${shiftKeys.length}</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn secondary smallbtn" data-act="addShift" type="button">+ Turno</button>
            <div class="badge">${escapeHtml(dep.id)}</div>
          </div>
        </div>
      `;

      const content = document.createElement("div");
      content.className = "content";
      content.style.padding = "12px";
      content.style.display = "flex";
      content.style.flexDirection = "column";
      content.style.gap = "12px";

      for(const sd of subdeps){
        const sdBox = document.createElement("div");
        sdBox.className = "dept";
        sdBox.style.background = "rgba(255,255,255,.02)";
        sdBox.innerHTML = `
          <div class="dept-head" style="border-bottom: 1px solid rgba(255,255,255,.06)">
            <div>
              <div class="dept-name" style="font-size:14px">${escapeHtml(sd.name)}</div>
              <div class="dept-sub">Sottoreparto</div>
            </div>
          </div>
        `;

        const sdContent = document.createElement("div");
        sdContent.className = "content";
        sdContent.style.padding = "12px";
        sdContent.style.display = "flex";
        sdContent.style.flexDirection = "column";
        sdContent.style.gap = "10px";

        for(const shiftKey of shiftKeys){
          const sft = shiftsObj[shiftKey] || {};
          const label = sft.label || "Turno";
          const startT = sft.start || "08:00";
          const endT = sft.end || "17:00";

          ensureSlot(dep.id, sd.id, shiftKey);
          const slot = dayData.assignments[assignKey(dep.id, sd.id, shiftKey)];

          const block = document.createElement("div");
          block.className = "shift";
          block.style.gridTemplateColumns = "220px 1fr";
          block.innerHTML = `
            <div class="shift-title">
              <b>${escapeHtml(label)}</b>
              <div class="small">${escapeHtml(startT)}–${escapeHtml(endT)}</div>
              <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
                <button class="btn secondary smallbtn" data-act="editShift" data-shift="${escapeHtml(shiftKey)}" type="button">Modifica orario</button>
                <button class="btn danger smallbtn" data-act="delShift" data-shift="${escapeHtml(shiftKey)}" type="button">Togli turno</button>
              </div>
              <div class="small muted" style="margin-top:8px">Capoturno</div>
              <div class="dropzone" data-role="leader" data-dep="${dep.id}" data-sub="${escapeHtml(sd.id)}" data-shift="${escapeHtml(shiftKey)}" style="min-height:44px"></div>
            </div>
            <div>
              <div class="small muted" style="margin-bottom:6px">Operatori</div>
              <div class="dropzone" data-role="staff" data-dep="${dep.id}" data-sub="${escapeHtml(sd.id)}" data-shift="${escapeHtml(shiftKey)}"></div>
            </div>
          `;

          // Leader rendering
          const leaderZone = block.querySelector('.dropzone[data-role="leader"]');
          const leaderId = slot.leader;
          if(!leaderId){
            leaderZone.innerHTML = `<div class="small muted">Trascina qui il capoturno</div>`;
          } else {
            const emp = employees.find(e=>e.id===leaderId);
            leaderZone.innerHTML = "";
            if(emp){
              const chip = document.createElement("div");
              chip.className = "chip";
              chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
              chip.querySelector("button").addEventListener("click", ()=>{
                slot.leader = null;
                saveDayDebounced();
                renderAll();
              });
              leaderZone.appendChild(chip);
            }
          }

          // Staff rendering
          const staffZone = block.querySelector('.dropzone[data-role="staff"]');
          const ids = slot.staff || [];
          if(ids.length === 0){
            staffZone.innerHTML = `<div class="small muted">Trascina qui i dipendenti</div>`;
          } else {
            staffZone.innerHTML = "";
            ids.forEach(empId=>{
              const emp = employees.find(e=>e.id===empId);
              if(!emp) return;
              const chip = document.createElement("div");
              chip.className = "chip";
              chip.innerHTML = `<span>${escapeHtml(emp.name)}</span><button title="Rimuovi">✕</button>`;
              chip.querySelector("button").addEventListener("click", ()=>{
                removeFromAllAssignments(empId);
                saveDayDebounced();
                renderAll();
              });
              staffZone.appendChild(chip);
            });
          }

          // Drag/drop
          block.querySelectorAll(".dropzone").forEach(zone=>{
            zone.addEventListener("dragover", (ev)=>{ ev.preventDefault(); zone.classList.add("over"); });
            zone.addEventListener("dragleave", ()=> zone.classList.remove("over"));
            zone.addEventListener("drop", (ev)=>{
              ev.preventDefault();
              zone.classList.remove("over");
              const empId = ev.dataTransfer.getData("text/plain") || draggingEmpId;
              if(!empId) return;
              const depId = zone.getAttribute("data-dep");
              const subId = zone.getAttribute("data-sub");
              const sk = zone.getAttribute("data-shift");
              const role = zone.getAttribute("data-role");
              if(role === "leader") setLeader(depId, subId, sk, empId);
              else addStaff(depId, subId, sk, empId);
              saveDayDebounced();
              renderAll();
            });
          });

          // Edit shift times (updates department settings)
          block.querySelector('[data-act="editShift"]').addEventListener("click", async ()=>{
            const start = prompt("Nuovo INIZIO (HH:MM)", startT);
            if(!start) return;
            const end = prompt("Nuovo FINE (HH:MM)", endT);
            if(!end) return;
            const label2 = prompt("Nome turno (opzionale)", label) || label;
            try{
              setSaving("Salvo orario…");
              const nextShifts = JSON.parse(JSON.stringify(shiftsObj));
              nextShifts[shiftKey] = { ...(nextShifts[shiftKey]||{}), start, end, label: label2 };
              await fb.updateDoc(fb.doc(db, "settings_departments", dep.id), { shifts: nextShifts });
              await loadSetup();
              await loadDay();
              renderAll();
              setSaving("Orario salvato");
            }catch(e){
              console.error(e);
              alert("Errore salvataggio orario: " + (e?.message || e));
              setSaving("Errore");
            }
          });

          // Delete shift (updates department settings)
          block.querySelector('[data-act="delShift"]').addEventListener("click", async ()=>{
            if(!confirm("Togliere questo turno dal reparto?")) return;
            try{
              setSaving("Tolgo turno…");
              const nextShifts = JSON.parse(JSON.stringify(shiftsObj));
              delete nextShifts[shiftKey];
              if(Object.keys(nextShifts).length === 0){
                alert("Deve rimanere almeno 1 turno.");
                setSaving("Pronto");
                return;
              }
              await fb.updateDoc(fb.doc(db, "settings_departments", dep.id), { shifts: nextShifts });
              await loadSetup();
              await loadDay();
              renderAll();
              setSaving("Turno tolto");
            }catch(e){
              console.error(e);
              alert("Errore: " + (e?.message || e));
              setSaving("Errore");
            }
          });

          sdContent.appendChild(block);
        }

        sdBox.appendChild(sdContent);
        content.appendChild(sdBox);
      }

      wrap.appendChild(content);
      deptBoard.appendChild(wrap);

      // Add shift from PROGRAMMA
      wrap.querySelector('[data-act="addShift"]').addEventListener("click", async ()=>{
        const start = prompt("Orario INIZIO turno (HH:MM)", "17:00");
        if(!start) return;
        const end = prompt("Orario FINE turno (HH:MM)", "21:00");
        if(!end) return;
        const label = prompt("Nome turno (opzionale)", "Turno") || "Turno";
        try{
          setSaving("Salvo turno…");
          const nums = shiftKeys.map(k=>Number(k.replace(/\D/g,""))||0);
          const nextN = (Math.max(...nums, 0) + 1);
          const newKey = "s" + nextN;
          const nextShifts = JSON.parse(JSON.stringify(shiftsObj));
          nextShifts[newKey] = { label, start, end };
          await fb.updateDoc(fb.doc(db, "settings_departments", dep.id), { shifts: nextShifts });
          await loadSetup();
          await loadDay();
          renderAll();
          setSaving("Turno aggiunto");
        }catch(e){
          console.error(e);
          alert("Errore aggiunta turno: " + (e?.message || e));
          setSaving("Errore");
        }
      });
    }
  }

  function renderPool({
    const q = ($("#search").value || "").trim().toLowerCase();
    const assigned = computeAssignedSet();
    const poolList = employees
      .filter(e => !assigned.has(e.id))
      .filter(e => !q || e.name.toLowerCase().includes(q));

    poolCount.textContent = `${poolList.length} liberi`;

    pool.innerHTML = "";
    if(poolList.length === 0){
      pool.innerHTML = `<div class="small muted">Nessun dipendente libero (o filtro attivo).</div>`;
      return;
    }
    for(const e of poolList){
      const row = document.createElement("div");
      row.className = "employee";
      row.draggable = true;
      row.innerHTML = `
        <div class="name">${escapeHtml(e.name)}</div>
        <div class="pill">drag</div>
      `;
      row.addEventListener("dragstart", (ev)=>{
        draggingEmpId = e.id;
        ev.dataTransfer.setData("text/plain", e.id);
        ev.dataTransfer.effectAllowed = "move";
      });
      row.addEventListener("dragend", ()=>{
        draggingEmpId = null;
      });
      pool.appendChild(row);
    }
  }

  // --- EXCEL EXPORT (settimana corrente) ---
  async function exportExcel(){
    const d = parseISODate(dayISO);
    const weekStart = startOfWeek(d);
    const days = [];
    for(let i=0;i<7;i++){
      const dd = new Date(weekStart);
      dd.setDate(weekStart.getDate()+i);
      days.push(formatISODate(dd));
    }
    const weekId = weekIdFromDate(d);

    // carica tutti i days doc della settimana
    const weekData = {}; // dayISO -> assignments
    for(const di of days){
      const ref = fb.doc(db, "schedules", weekId, "days", di);
      const snap = await fb.getDoc(ref);
      weekData[di] = snap.exists() ? (snap.data().assignments || {}) : {};
    }

    // carica SheetJS on-demand
    const { utils, writeFile } = await import("https://cdn.sheetjs.com/xlsx-0.20.2/package/xlsx.mjs");

    const header = ["REPARTO / TURNO", ...days.map(s=>s)];
    const rows = [header];

    for(const dep of departments){
      const s1 = dep.shifts?.s1 || { label:"Turno 1", start:"07:00", end:"13:00" };
      const s2 = dep.shifts?.s2 || { label:"Turno 2", start:"13:00", end:"19:00" };

      // Riga compatta per reparto: in ogni cella metti T1/T2
      const r = [`${dep.name}`];
      for(const di of days){
        const a = weekData[di]?.[dep.id] || { s1:[], s2:[] };
        const names1 = (a.s1||[]).map(id => employees.find(e=>e.id===id)?.name).filter(Boolean);
        const names2 = (a.s2||[]).map(id => employees.find(e=>e.id===id)?.name).filter(Boolean);
        const cell = `T1 (${s1.start}-${s1.end}): ${names1.join(", ")}\nT2 (${s2.start}-${s2.end}): ${names2.join(", ")}`;
        r.push(cell);
      }
      rows.push(r);
    }

    const ws = utils.aoa_to_sheet(rows);
    ws["!cols"] = [{wch:22}, ...days.map(()=>({wch:34}))];

    const wb = utils.book_new();
    utils.book_append_sheet(wb, ws, "Programma");
    writeFile(wb, `programma-magazzino_${weekId}.xlsx`);
  }
</script>

<script>
(function(){
  const panel = document.getElementById('debugPanel');
  const logEl = document.getElementById('debugLog');
  const closeBtn = document.getElementById('debugClose');
  function show(){ panel.style.display='block'; }
  function log(msg){
    show();
    const div=document.createElement('div');
    div.textContent = msg;
    logEl.appendChild(div);
  }
  closeBtn && closeBtn.addEventListener('click', ()=> panel.style.display='none');

  window.addEventListener('error', (e)=>{
    log('[JS error] ' + (e.message || e.error || 'errore') + ' @ ' + (e.filename||'') + ':' + (e.lineno||'') );
  });
  window.addEventListener('unhandledrejection', (e)=>{
    log('[Promise] ' + (e.reason && (e.reason.message||String(e.reason))) );
  });

  // ping that base script executed
  log('[OK] Debug attivo. UserAgent: ' + navigator.userAgent);
})();
</script>

<script id="moduleStatusBanner">
(function(){
  function show(){
    const div=document.createElement('div');
    div.style.position='fixed';
    div.style.top='10px';
    div.style.left='10px';
    div.style.zIndex='99999';
    div.style.padding='8px 10px';
    div.style.borderRadius='12px';
    div.style.background='rgba(0,0,0,.75)';
    div.style.border='1px solid rgba(255,255,255,.18)';
    div.style.color='#e5e7eb';
    div.style.fontSize='12px';
    div.textContent = window.__MODULE_LOADED__ ? ('Module OK: ' + window.__MODULE_LOADED__.map(x=>x.page).join(', ')) : 'ATTENZIONE: moduli NON caricati';
    document.body.appendChild(div);
    setTimeout(()=>div.remove(), 8000);
  }
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', show);
  else show();
})();
</script>
</body>
</html>
