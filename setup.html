<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SETUP — Programma Magazzino</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <a href="./index.html" style="text-decoration:none">
          <div style="font-size:18px;font-weight:800">Programma Magazzino</div>
        </a>
        <span class="badge">SETUP</span>
      </div>
      <div class="row">
        <a class="btn secondary" href="./programma.html">PROGRAMMA</a>
        <button class="btn danger" id="btnLogout">Esci</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header><h2>Dipendenti</h2></header>
        <div class="content">
          <div class="row">
            <div class="field" style="flex:1;min-width:260px">
              <label>Nome dipendente</label>
              <input id="empName" placeholder="Es. Mario Rossi"/>
            </div>
            <div class="field" style="min-width:120px">
              <label>&nbsp;</label>
              <button class="btn" id="btnAddEmp">Aggiungi</button>
            </div>
          </div>

          <div class="small" style="margin-top:10px">Suggerimento: usa nomi brevi (nome + iniziale) per farli entrare bene nel PDF/Excel.</div>

          <hr class="sep"/>
          <div id="empList" class="row" style="flex-direction:column;align-items:stretch;gap:8px"></div>
        </div>
      </div>

      <div class="card">
        <header><h2>Reparti e turni</h2></header>
        <div class="content">
          <div class="notice">
            Reparti fissi (ordinabili). Qui imposti i 2 turni e gli orari.
            <div class="small" style="margin-top:6px">Il programma usa questi orari per mostrare i turni e per l'export.</div>
          </div>

          <hr class="sep"/>
          <div id="deptList" style="display:flex;flex-direction:column;gap:10px"></div>

          <div class="footer-actions" style="margin-top:12px">
            <button class="btn secondary" id="btnResetDepts">Ripristina reparti fissi</button>
            <span class="small" id="saveMsg"></span>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { auth, db, fb } from "./js/firebase.js";
  import { FIXED_DEPARTMENTS, DEFAULT_SHIFTS } from "./js/constants.js";
  import { $, $$, escapeHtml, debounce } from "./js/utils.js";

  const empList = $("#empList");
  const deptList = $("#deptList");
  const saveMsg = $("#saveMsg");

  function flash(t){
    saveMsg.textContent = t || "";
    if(t){ setTimeout(()=>saveMsg.textContent="", 1600); }
  }

  fb.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href = "./index.html"; return; }
    await ensureDepartments();
    await renderDepartments();
    await renderEmployees();
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await fb.signOut(auth);
    location.href = "./index.html";
  });

  // --- EMPLOYEES ---
  async function renderEmployees(){
    empList.innerHTML = "";
    const q = fb.query(fb.collection(db, "settings_employees"), fb.orderBy("name"));
    const snap = await fb.getDocs(q);
    if(snap.empty){
      empList.innerHTML = '<div class="small muted">Nessun dipendente inserito.</div>';
      return;
    }
    snap.forEach(docu=>{
      const e = docu.data();
      const row = document.createElement("div");
      row.className = "employee";
      row.innerHTML = `
        <div class="name">${escapeHtml(e.name)}</div>
        <div class="row" style="gap:8px">
          <span class="pill">${e.active === false ? "disattivo" : "attivo"}</span>
          <button class="btn secondary" data-act="toggle">Attiva/Disattiva</button>
          <button class="btn danger" data-act="del">Elimina</button>
        </div>
      `;
      row.querySelector('[data-act="toggle"]').addEventListener("click", async ()=>{
        await fb.updateDoc(fb.doc(db, "settings_employees", docu.id), { active: !(e.active === false) });
        await renderEmployees();
      });
      row.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
        if(!confirm("Eliminare il dipendente?")) return;
        await fb.deleteDoc(fb.doc(db, "settings_employees", docu.id));
        await renderEmployees();
      });
      empList.appendChild(row);
    });
  }

  $("#btnAddEmp").addEventListener("click", async ()=>{
    const name = $("#empName").value.trim();
    if(!name) return;
    await fb.addDoc(fb.collection(db, "settings_employees"), { name, active:true, createdAt: Date.now() });
    $("#empName").value = "";
    await renderEmployees();
  });

  // --- DEPARTMENTS ---
  async function ensureDepartments(){
    // Se vuoto, inserisce FIXED_DEPARTMENTS con turni default
    const q = fb.query(fb.collection(db, "settings_departments"));
    const snap = await fb.getDocs(q);
    if(!snap.empty) return;
    for(const d of FIXED_DEPARTMENTS){
      await fb.setDoc(fb.doc(db, "settings_departments", d.id), {
        name: d.name,
        order: d.order,
        shifts: DEFAULT_SHIFTS
      });
    }
  }

  async function resetDepartmentsToFixed(){
    // Sovrascrive i doc con i reparti fissi (mantiene eventuali custom? per semplicità reset totale)
    for(const d of FIXED_DEPARTMENTS){
      await fb.setDoc(fb.doc(db, "settings_departments", d.id), {
        name: d.name,
        order: d.order,
        shifts: DEFAULT_SHIFTS
      }, { merge: true });
    }
  }

  $("#btnResetDepts").addEventListener("click", async ()=>{
    if(!confirm("Ripristinare reparti fissi e orari default?")) return;
    await resetDepartmentsToFixed();
    await renderDepartments();
    flash("Ripristinato.");
  });

  const saveDeptDebounced = debounce(async (id, patch)=>{
    await fb.updateDoc(fb.doc(db, "settings_departments", id), patch);
    flash("Salvato.");
  }, 450);

  async function renderDepartments(){
    deptList.innerHTML = "";
    const q = fb.query(fb.collection(db, "settings_departments"), fb.orderBy("order"));
    const snap = await fb.getDocs(q);

    snap.forEach(docu=>{
      const d = docu.data();
      const box = document.createElement("div");
      box.className = "dept";
      box.innerHTML = `
        <div class="dept-head">
          <div>
            <div class="dept-name">${escapeHtml(d.name || docu.id)}</div>
            <div class="dept-sub">ID: <span class="kbd">${docu.id}</span></div>
          </div>
          <div class="row" style="gap:8px">
            <div class="field" style="min-width:120px">
              <label>Ordine</label>
              <input data-k="order" type="number" value="${Number(d.order ?? 0)}" style="max-width:110px"/>
            </div>
          </div>
        </div>

        <div class="content" style="padding:12px">
          <div class="row">
            <div class="field" style="min-width:220px;flex:1">
              <label>Nome reparto</label>
              <input data-k="name" value="${escapeHtml(d.name || "")}"/>
            </div>
          </div>

          <hr class="sep"/>

          <div class="row">
            <div class="field" style="min-width:160px">
              <label>Turno 1 — Inizio</label>
              <input data-k="s1start" type="time" value="${escapeHtml(d.shifts?.s1?.start || "07:00")}"/>
            </div>
            <div class="field" style="min-width:160px">
              <label>Turno 1 — Fine</label>
              <input data-k="s1end" type="time" value="${escapeHtml(d.shifts?.s1?.end || "13:00")}"/>
            </div>
            <div class="field" style="min-width:160px">
              <label>Turno 2 — Inizio</label>
              <input data-k="s2start" type="time" value="${escapeHtml(d.shifts?.s2?.start || "13:00")}"/>
            </div>
            <div class="field" style="min-width:160px">
              <label>Turno 2 — Fine</label>
              <input data-k="s2end" type="time" value="${escapeHtml(d.shifts?.s2?.end || "19:00")}"/>
            </div>
          </div>
        </div>
      `;

      box.querySelectorAll("input").forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const k = inp.getAttribute("data-k");
          const val = inp.type === "number" ? Number(inp.value) : inp.value;

          if(k === "order"){
            saveDeptDebounced(docu.id, { order: val });
          } else if(k === "name"){
            saveDeptDebounced(docu.id, { name: val });
          } else {
            const shifts = {
              s1: { ...(d.shifts?.s1 || {}), start: box.querySelector('[data-k="s1start"]').value, end: box.querySelector('[data-k="s1end"]').value, label:"Turno 1" },
              s2: { ...(d.shifts?.s2 || {}), start: box.querySelector('[data-k="s2start"]').value, end: box.querySelector('[data-k="s2end"]').value, label:"Turno 2" }
            };
            saveDeptDebounced(docu.id, { shifts });
          }
        });
      });

      deptList.appendChild(box);
    });
  }
</script>
</body>
</html>
