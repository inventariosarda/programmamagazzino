<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SETUP — Programma Magazzino</title>
  <link rel="stylesheet" href="./styles.css"/>
</head>
<body>
  <div id="debugPanel" style="position:fixed;left:10px;bottom:10px;right:10px;max-height:35vh;overflow:auto;z-index:9999;display:none;background:rgba(0,0,0,.85);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px;font-size:12px;line-height:1.4;color:#e5e7eb">
    <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;margin-bottom:6px">
      <b>Debug</b>
      <button id="debugClose" style="border:none;background:rgba(255,255,255,.1);color:#e5e7eb;padding:6px 10px;border-radius:10px;cursor:pointer">Chiudi</button>
    </div>
    <div id="debugLog"></div>
  </div>

  <div class="container">
    <div class="topbar">
      <div class="brand">
        <a href="./index.html" style="text-decoration:none">
          <div style="font-size:18px;font-weight:800">Programma Magazzino</div>
        </a>
        <span class="badge">SETUP</span>
      </div>
      <div class="row">
        <a class="btn secondary" href="./programma.html">PROGRAMMA</a>
        <button class="btn danger" id="btnLogout">Esci</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <header><h2>Dipendenti</h2></header>
        <div class="content">
          <div class="row">
            <div class="field" style="flex:1;min-width:260px">
              <label>Nome dipendente</label>
              <input id="empName" placeholder="Es. Mario Rossi"/>
            </div>
            <div class="field" style="min-width:120px">
              <label>&nbsp;</label>
              <button class="btn" id="btnAddEmp" type="button">Aggiungi</button>
            </div>
          </div>
            <div class="field" style="min-width:170px">
              <label>&nbsp;</label>
              <button class="btn secondary" id="btnTestWrite" type="button">Test scrittura DB</button>
            </div>

          <div class="small" style="margin-top:10px">Suggerimento: usa nomi brevi (nome + iniziale) per farli entrare bene nel PDF/Excel.</div>
<div class="small" id="empMsg" style="margin-top:8px"></div>

          <hr class="sep"/>
          <div id="empList" class="row" style="flex-direction:column;align-items:stretch;gap:8px"></div>
        </div>
      </div>

      <div class="card">
        <header><h2>Reparti e turni</h2></header>
        <div class="content">
          <div class="notice">
            Reparti fissi (ordinabili). Qui imposti i 2 turni e gli orari.
            <div class="small" style="margin-top:6px">Il programma usa questi orari per mostrare i turni e per l'export.</div>
          </div>

          <hr class="sep"/>
          <div class="row">
            <div class="field" style="flex:1;min-width:260px">
              <label>Nuovo reparto</label>
              <input id="newDeptName" placeholder="Es. Confezione speciale"/>
            </div>
            <div class="field" style="min-width:120px">
              <label>Ordine</label>
              <input id="newDeptOrder" type="number" value="999"/>
            </div>
            <div class="field" style="min-width:140px">
              <label>&nbsp;</label>
              <button class="btn" id="btnAddDept" type="button">Aggiungi reparto</button>
            </div>
          </div>
          <div class="small" id="deptMsg" style="margin-top:8px"></div>
          <hr class="sep"/>
          <div id="deptList" style="display:flex;flex-direction:column;gap:10px"></div>

          <div class="footer-actions" style="margin-top:12px">
            <button class="btn secondary" id="btnResetDepts">Ripristina reparti fissi</button>
            <span class="small" id="saveMsg"></span>
          </div>
        </div>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-app-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/firebase@10.12.5/firebase-firestore-compat.js"></script>
  <script src="./js/firebase-config-global.js"></script>

<script type="module">
  import { auth, db, fb } from "./js/firebase.js";
  import { FIXED_DEPARTMENTS, DEFAULT_SHIFTS } from "./js/constants.js";
  import { $, $$, escapeHtml, debounce } from "./js/utils.js";

  const empList = $("#empList");
  const deptList = $("#deptList");
  const saveMsg = $("#saveMsg");
  const empMsg = $("#empMsg");
  const deptMsg = $("#deptMsg");

  
  function sayEmp(t){ empMsg.textContent = t || ""; if(t){ setTimeout(()=>empMsg.textContent="", 2200);} }
  function sayDept(t){ deptMsg.textContent = t || ""; if(t){ setTimeout(()=>deptMsg.textContent="", 2200);} }

  function slugify(str){
    return String(str)
      .normalize("NFKD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "_")
      .replace(/^_+|_+$/g, "")
      .replace(/_+/g, "_");
  }
function flash(t){
    saveMsg.textContent = t || "";
    if(t){ setTimeout(()=>saveMsg.textContent="", 1600); }
  }

  fb.onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href = "./index.html"; return; }
    await ensureDepartments();
    await renderDepartments();
    await renderEmployees();
  });

  $("#btnLogout").addEventListener("click", async ()=>{
    await fb.signOut(auth);
    location.href = "./index.html";
  });

  // --- EMPLOYEES ---
  async function renderEmployees(){
    empList.innerHTML = "";
    const q = fb.query(fb.collection(db, "settings_employees"), fb.orderBy("name"));
    const snap = await fb.getDocs(q);
    if(snap.empty){
      empList.innerHTML = '<div class="small muted">Nessun dipendente inserito.</div>';
      return;
    }
    snap.forEach(docu=>{
      const e = docu.data();
      const row = document.createElement("div");
      row.className = "employee";
      row.innerHTML = `
        <div class="name">${escapeHtml(e.name)}</div>
        <div class="row" style="gap:8px">
          <span class="pill">${e.active === false ? "disattivo" : "attivo"}</span>
          <button class="btn secondary" data-act="toggle">Attiva/Disattiva</button>
          <button class="btn danger" data-act="del">Elimina</button>
        </div>
      `;
      row.querySelector('[data-act="toggle"]').addEventListener("click", async ()=>{
        await fb.updateDoc(fb.doc(db, "settings_employees", docu.id), { active: !(e.active === false) });
        await renderEmployees();
      });
      row.querySelector('[data-act="del"]').addEventListener("click", async ()=>{
        if(!confirm("Eliminare il dipendente?")) return;
        await fb.deleteDoc(fb.doc(db, "settings_employees", docu.id));
        await renderEmployees();
      });
      empList.appendChild(row);
    });
  }

  $("#btnTestWrite").addEventListener("click", async ()=>{
    sayEmp("");
    try{
      await fb.setDoc(fb.doc(db, "debug", "test_write"), { ts: Date.now(), by: auth.currentUser?.email || null });
      sayEmp("Test OK: scrittura su Firestore riuscita.");
    }catch(e){
      console.error(e);
      sayEmp("Test FALLITO: " + (e?.message || e));
      alert("Test Firestore fallito: " + (e?.message || e));
    }
  });

  $("#btnAddEmp").addEventListener("click", async ()=>{
    sayEmp("");
    const name = $("#empName").value.trim();
    if(!name){ sayEmp("Inserisci un nome."); return; }
    try{
      await fb.addDoc(fb.collection(db, "settings_employees"), { name, active:true, createdAt: Date.now() });
      $("#empName").value = "";
      await renderEmployees();
      sayEmp("Dipendente aggiunto.");
    }catch(e){
      console.error(e);
      sayEmp("Errore aggiunta dipendente: " + (e?.message || e));
      alert("Errore aggiunta dipendente. Apri la console per dettagli.");
    }
  });

  // --- DEPARTMENTS ---
  async function ensureDepartments(){
    // Se vuoto, inserisce FIXED_DEPARTMENTS con turni default
    const q = fb.query(fb.collection(db, "settings_departments"));
    const snap = await fb.getDocs(q);
    if(!snap.empty) return;
    for(const d of FIXED_DEPARTMENTS){
      await fb.setDoc(fb.doc(db, "settings_departments", d.id), {
        name: d.name,
        order: d.order,
        shifts: DEFAULT_SHIFTS
      });
    }
  }

  async function resetDepartmentsToFixed(){
    // Sovrascrive i doc con i reparti fissi (mantiene eventuali custom? per semplicità reset totale)
    for(const d of FIXED_DEPARTMENTS){
      await fb.setDoc(fb.doc(db, "settings_departments", d.id), {
        name: d.name,
        order: d.order,
        shifts: DEFAULT_SHIFTS
      }, { merge: true });
    }
  }

  $("#btnResetDepts").addEventListener("click", async ()=>{
    if(!confirm("Ripristinare reparti fissi e orari default?")) return;
    await resetDepartmentsToFixed();
    await renderDepartments();
    flash("Ripristinato.");
  });
  $("#btnAddDept").addEventListener("click", async ()=>{
    sayDept("");
    const name = $("#newDeptName").value.trim();
    if(!name){ sayDept("Inserisci il nome del reparto."); return; }
    const order = Number($("#newDeptOrder").value || 999);
    const baseId = slugify(name) || "reparto";
    const id = baseId + "_" + Math.random().toString(36).slice(2,7);
    try{
      await fb.setDoc(fb.doc(db, "settings_departments", id), {
        name,
        order,
        shifts: DEFAULT_SHIFTS
      });
      $("#newDeptName").value = "";
      $("#newDeptOrder").value = String(order + 10);
      await renderDepartments();
      sayDept("Reparto aggiunto.");
    }catch(e){
      console.error(e);
      sayDept("Errore aggiunta reparto: " + (e?.message || e));
      alert("Errore aggiunta reparto. Apri la console per dettagli.");
    }
  });


  const saveDeptDebounced = debounce(async (id, patch)=>{
    await fb.updateDoc(fb.doc(db, "settings_departments", id), patch);
    flash("Salvato.");
  }, 450);

  
  async function renderDepartments(){
    deptList.innerHTML = "";
    const q = fb.query(fb.collection(db, "settings_departments"), fb.orderBy("order"));
    const snap = await fb.getDocs(q);

    if(snap.empty){
      deptList.innerHTML = '<div class="small muted">Nessun reparto presente.</div>';
      return;
    }

    snap.forEach(docu=>{
      const d = docu.data();
      const shiftsObj = d.shifts || DEFAULT_SHIFTS;

      const box = document.createElement("div");
      box.className = "dept";

      // Costruisci lista turni (ordinata per chiave: s1, s2, s3...)
      const shiftKeys = Object.keys(shiftsObj).sort((a,b)=>{
        const na = Number(a.replace(/\D/g,"")) || 0;
        const nb = Number(b.replace(/\D/g,"")) || 0;
        return na - nb;
      });

      const shiftsHtml = shiftKeys.map((k)=> {
        const s = shiftsObj[k] || {};
        const label = s.label || k.toUpperCase();
        const start = s.start || "07:00";
        const end = s.end || "13:00";
        return `
          <div class="dept" style="border:none;background:transparent">
            <div class="row" style="align-items:flex-end;gap:10px">
              <div class="field" style="min-width:200px;flex:1">
                <label>${escapeHtml(k)} — Etichetta</label>
                <input data-shift="${escapeHtml(k)}" data-k="label" value="${escapeHtml(label)}"/>
              </div>
              <div class="field" style="min-width:160px">
                <label>Inizio</label>
                <input data-shift="${escapeHtml(k)}" data-k="start" type="time" value="${escapeHtml(start)}"/>
              </div>
              <div class="field" style="min-width:160px">
                <label>Fine</label>
                <input data-shift="${escapeHtml(k)}" data-k="end" type="time" value="${escapeHtml(end)}"/>
              </div>
              <div class="field" style="min-width:130px">
                <label>&nbsp;</label>
                <button class="btn danger" data-act="delShift" data-shift="${escapeHtml(k)}">Elimina turno</button>
              </div>
            </div>
          </div>
        `;
      }).join('<hr class="sep"/>');

      box.innerHTML = `
        <div class="dept-head">
          <div>
            <div class="dept-name">${escapeHtml(d.name || docu.id)}</div>
            <div class="dept-sub">ID: <span class="kbd">${docu.id}</span></div>
          </div>
          <div class="row" style="gap:8px">
            <div class="field" style="min-width:120px">
              <label>Ordine</label>
              <input data-k="order" type="number" value="${Number(d.order ?? 0)}" style="max-width:110px"/>
            </div>
            <button class="btn secondary" data-act="addShift">+ Turno</button>
            <button class="btn danger" data-act="delDept">Elimina reparto</button>
          </div>
        </div>

        <div class="content" style="padding:12px">
          <div class="row">
            <div class="field" style="min-width:220px;flex:1">
              <label>Nome reparto</label>
              <input data-k="name" value="${escapeHtml(d.name || "")}"/>
            </div>
          </div>

          <hr class="sep"/>

          <div style="display:flex;flex-direction:column;gap:10px" data-area="shifts">
            ${shiftsHtml}
          </div>
        </div>
      `;

      // handlers base fields
      box.querySelectorAll('input[data-k="order"]').forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const val = Number(inp.value);
          saveDeptDebounced(docu.id, { order: val });
        });
      });
      box.querySelectorAll('input[data-k="name"]').forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const val = inp.value;
          saveDeptDebounced(docu.id, { name: val });
        });
      });

      // handlers shift fields
      box.querySelectorAll('[data-area="shifts"] input').forEach(inp=>{
        inp.addEventListener("input", ()=>{
          const sk = inp.getAttribute("data-shift");
          const k = inp.getAttribute("data-k");
          const val = inp.value;
          const current = (d.shifts || DEFAULT_SHIFTS);
          const next = JSON.parse(JSON.stringify(current));
          next[sk] = next[sk] || {};
          next[sk][k] = val;
          saveDeptDebounced(docu.id, { shifts: next });
        });
      });

      // delete shift
      box.querySelectorAll('[data-act="delShift"]').forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const sk = btn.getAttribute("data-shift");
          if(!confirm(`Eliminare il turno ${sk}?`)) return;
          const current = (d.shifts || DEFAULT_SHIFTS);
          const next = JSON.parse(JSON.stringify(current));
          delete next[sk];
          // evita reparto senza turni
          if(Object.keys(next).length === 0){
            alert("Non puoi lasciare il reparto senza turni.");
            return;
          }
          await fb.updateDoc(fb.doc(db, "settings_departments", docu.id), { shifts: next });
          flash("Salvato.");
          await renderDepartments();
        });
      });

      // add shift (global)
      box.querySelector('[data-act="addShift"]').addEventListener("click", async ()=>{
        const current = (d.shifts || DEFAULT_SHIFTS);
        const keys = Object.keys(current);
        const nums = keys.map(k=>Number(k.replace(/\D/g,""))||0);
        const nextN = (Math.max(...nums, 2) + 1);
        const newKey = "s" + nextN;

        const start = prompt(`Orario INIZIO per ${newKey} (HH:MM)`, "19:00");
        if(!start) return;
        const end = prompt(`Orario FINE per ${newKey} (HH:MM)`, "23:00");
        if(!end) return;

        const next = JSON.parse(JSON.stringify(current));
        next[newKey] = { label: `Turno ${nextN}`, start, end };
        try{
          await fb.updateDoc(fb.doc(db, "settings_departments", docu.id), { shifts: next });
          flash("Turno aggiunto.");
          await renderDepartments();
        }catch(e){
          console.error(e);
          alert("Errore aggiunta turno: " + (e?.message || e));
        }
      });

      // delete department
      box.querySelector('[data-act="delDept"]').addEventListener("click", async ()=>{
        if(!confirm("Eliminare il reparto? (Attenzione: non cancella automaticamente le assegnazioni già fatte nei giorni)")) return;
        try{
          await fb.deleteDoc(fb.doc(db, "settings_departments", docu.id));
          flash("Reparto eliminato.");
          await renderDepartments();
        }catch(e){
          console.error(e);
          alert("Errore eliminazione reparto: " + (e?.message || e));
        }
      });

      deptList.appendChild(box);
    });
  }

</script>

<script>
(function(){
  const panel = document.getElementById('debugPanel');
  const logEl = document.getElementById('debugLog');
  const closeBtn = document.getElementById('debugClose');
  function show(){ panel.style.display='block'; }
  function log(msg){
    show();
    const div=document.createElement('div');
    div.textContent = msg;
    logEl.appendChild(div);
  }
  closeBtn && closeBtn.addEventListener('click', ()=> panel.style.display='none');

  window.addEventListener('error', (e)=>{
    log('[JS error] ' + (e.message || e.error || 'errore') + ' @ ' + (e.filename||'') + ':' + (e.lineno||'') );
  });
  window.addEventListener('unhandledrejection', (e)=>{
    log('[Promise] ' + (e.reason && (e.reason.message||String(e.reason))) );
  });

  // ping that base script executed
  log('[OK] Debug attivo. UserAgent: ' + navigator.userAgent);
})();
</script>
</body>
</html>
